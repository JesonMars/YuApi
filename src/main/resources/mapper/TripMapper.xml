<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pingo.yuapi.mapper.TripMapper">

    <resultMap id="TripResultMap" type="com.pingo.yuapi.entity.Trip">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="user_id" property="userId" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="VARCHAR"/>

        <!-- 核心地点信息 -->
        <result column="start_city" property="startCity" jdbcType="VARCHAR"/>
        <result column="start_location" property="startLocation" jdbcType="VARCHAR"/>
        <result column="start_longitude" property="startLongitude" jdbcType="DOUBLE"/>
        <result column="start_latitude" property="startLatitude" jdbcType="DOUBLE"/>
        <result column="end_city" property="endCity" jdbcType="VARCHAR"/>
        <result column="end_location" property="endLocation" jdbcType="VARCHAR"/>
        <result column="end_longitude" property="endLongitude" jdbcType="DOUBLE"/>
        <result column="end_latitude" property="endLatitude" jdbcType="DOUBLE"/>

        <!-- 核心时间信息 -->
        <result column="departure_time" property="departureTime" jdbcType="TIMESTAMP"/>
        <result column="timing" property="timing" jdbcType="VARCHAR"/>

        <!-- 核心数量信息 -->
        <result column="available_seats" property="availableSeats" jdbcType="INTEGER"/>
        <result column="booked_seats" property="bookedSeats" jdbcType="INTEGER"/>

        <!-- 核心价格信息（分） -->
        <result column="price" property="price" jdbcType="BIGINT"/>

        <!-- 状态 -->
        <result column="status" property="status" jdbcType="VARCHAR"/>

        <!-- 时间戳 -->
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 查询所有行程，按出发时间排序 -->
    <select id="selectAllTrips" resultMap="TripResultMap">
        SELECT * FROM trips 
        ORDER BY departure_time ASC
    </select>

    <!-- 根据条件查询行程 -->
    <select id="selectTripsByCondition" parameterType="map" resultMap="TripResultMap">
        SELECT * FROM trips
        <where>
            <if test="date != null">
                DATE(departure_time) = #{date}
            </if>
            <if test="type != null">
                AND type = #{type}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="timing != null">
                AND timing = #{timing}
            </if>
            <if test="startLocation != null">
                AND start_location LIKE CONCAT('%', #{startLocation}, '%')
            </if>
            <if test="endLocation != null">
                AND end_location LIKE CONCAT('%', #{endLocation}, '%')
            </if>
        </where>
        ORDER BY departure_time ASC
    </select>

    <!-- 查询今天的可用行程 -->
    <select id="selectTodayTrips" resultMap="TripResultMap">
        SELECT * FROM trips 
        WHERE DATE(departure_time) = DATE(#{now})
        AND departure_time > #{now}
        AND status = 'available'
        ORDER BY departure_time ASC
    </select>

    <!-- 根据日期查询行程 -->
    <select id="selectTripsByDate" resultMap="TripResultMap">
        SELECT * FROM trips 
        WHERE DATE(departure_time) = #{targetDate}
        AND status = 'available'
        ORDER BY departure_time ASC
    </select>

    <!-- 根据ID查询行程 -->
    <select id="selectTripById" resultMap="TripResultMap">
        SELECT * FROM trips WHERE id = #{id}
    </select>

    <!-- 插入行程 -->
    <insert id="insertTrip" parameterType="com.pingo.yuapi.entity.Trip">
        INSERT INTO trips (
            id, user_id, type,
            start_city, start_location, start_longitude, start_latitude,
            end_city, end_location, end_longitude, end_latitude,
            departure_time, timing,
            available_seats, booked_seats, price,
            status
        ) VALUES (
            #{id}, #{userId}, #{type},
            #{startCity}, #{startLocation}, #{startLongitude}, #{startLatitude},
            #{endCity}, #{endLocation}, #{endLongitude}, #{endLatitude},
            #{departureTime}, #{timing},
            #{availableSeats}, #{bookedSeats}, #{price},
            #{status}
        )
    </insert>

    <!-- 更新行程 -->
    <update id="updateTrip" parameterType="com.pingo.yuapi.entity.Trip">
        UPDATE trips SET
            start_city = #{startCity},
            start_location = #{startLocation},
            start_longitude = #{startLongitude},
            start_latitude = #{startLatitude},
            end_city = #{endCity},
            end_location = #{endLocation},
            end_longitude = #{endLongitude},
            end_latitude = #{endLatitude},
            departure_time = #{departureTime},
            timing = #{timing},
            available_seats = #{availableSeats},
            booked_seats = #{bookedSeats},
            price = #{price},
            status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 删除行程 -->
    <delete id="deleteTripById">
        DELETE FROM trips WHERE id = #{id}
    </delete>

    <!-- 查询用户的行程 -->
    <select id="selectUserTrips" resultMap="TripResultMap">
        SELECT * FROM trips
        WHERE user_id = #{userId}
        ORDER BY create_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 统计指定状态的行程数量 -->
    <select id="countTripsByStatus" resultType="int">
        SELECT COUNT(*) FROM trips WHERE status = #{status}
    </select>

    <!-- 更新行程状态 -->
    <update id="updateTripStatus">
        UPDATE trips SET 
            status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 减少可用座位数 -->
    <update id="decreaseAvailableSeats">
        UPDATE trips SET 
            available_seats = available_seats - #{count}
        WHERE id = #{id}
        AND available_seats >= #{count}
    </update>

</mapper>